<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Nest.js | 知瑾</title><meta name="keywords" content="nestjs"><meta name="author" content="知瑾"><meta name="copyright" content="知瑾"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Nest.js"><meta name="application-name" content="Nest.js"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Nest.js"><meta property="og:url" content="http://example.com/2022/09/03/Nestjs/index.html"><meta property="og:site_name" content="知瑾"><meta property="og:description" content="Nestjs创建 Nestjs 项目12npm i -g @nestjs&amp;#x2F;clinest new project-name  模块模块是使用@Module装饰器的类，@Module装饰器提供元数据，Nest 应用是很多模块组成。一个应用至少有一个模块。 @Module装饰器接受 4 个属性：  pr"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.zhimg.com%2Fv2-f6241353ba024915b991e8d5847b8da2_1440w.jpg%3Fsource%3D172ae18b&amp;refer=http%3A%2F%2Fpic1.zhimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1659410579&amp;t=a3fd1f73c15a8fe0f9b98e0520731d31"><meta property="article:author" content="知瑾"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.zhimg.com%2Fv2-f6241353ba024915b991e8d5847b8da2_1440w.jpg%3Fsource%3D172ae18b&amp;refer=http%3A%2F%2Fpic1.zhimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1659410579&amp;t=a3fd1f73c15a8fe0f9b98e0520731d31"><meta name="description" content="Nestjs创建 Nestjs 项目12npm i -g @nestjs&amp;#x2F;clinest new project-name  模块模块是使用@Module装饰器的类，@Module装饰器提供元数据，Nest 应用是很多模块组成。一个应用至少有一个模块。 @Module装饰器接受 4 个属性：  pr"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2022/09/03/Nestjs/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://cdn.jsdelivr.net/gh/berniezhong/picture-bed/github/202406031028986.png"},
  postHeadAiDescription: undefined,
  diytitle: undefined,
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"","mailMd5":""},
  root: '/',
  preloader: {"source":2},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '知瑾',
  title: 'Nest.js',
  postAI: '',
  pageFillDescription: 'Nestjs, 创建 Nestjs 项目, 模块, 功能模块, 共享模块, 依赖注入, 全局模块, 控制器, 路由, Request, 状态码, 重定向, 完整示例, 服务, 中间件, 应用中间件, 全局中间件, 异常过滤器, 简单的异常过滤器, 绑定过滤器, 全局异常过滤器, 管道, 管道示例, 自定义管道, 守卫, 授权守卫, 绑定守卫, 为每个处理器设置角色, 自定义装饰器, 参数装饰器, 传递数据, Jwt 鉴权, 身份认证, TypeORM, 安装依赖创建项目模块模块是使用装饰器的类装饰器提供元数据应用是很多模块组成一个应用至少有一个模块装饰器接受个属性向模块注入实例化的提供者可以在整个模块中共享数据控制器必须创建导入其他模块的列表导出当前模块供其他模块使用创建模块使用命令创建的模块会自动注入到根模块创建模块后到目录功能模块一个模块有对应的和层应该封装在一个功能模块下共享模块默认情况下模块是单例所以可以在多个模块中共享同一个模块实例当模块需要被其他模块共享时需要将模块放到当前模块的中在应用模块中在定义模块共享可以在控制层相互调用例如在狗的模块中调用猫的模块依赖注入也可以注入到中一般用于配置信息目的相反不可以将注入到中全局模块提供一种全局模块无需每个模块都导入一遍通常会将数据库连接等全局导入随时随地使用需要使用装饰器使其成为全局模块在核心模块中注册这种全局模块注册后在别的模块中不需要使用导入控制器控制器负责处理传入的请求和向客户端返回响应控制器的目的是接受特定请求每个控制器有多个路由每个路由执行不同的操作控制器使用装饰器定义路由创建路由在中使用路径前缀可以对一组相关的路由进行分组代表模块的路由有个前缀任何在模块中的路由都需要添加来访问匹配的路由是通配参数动态参数路由方式还包括了为了在中使用请安装提供了对底层平台的请求对象基于的访问方式可以在处理函数签名中使用装饰器指示将请求对象注入函数中请求具有查询字符串请求参数标头的属性方法描述假设路由携带参数那么中的值就是状态码默认情况下接口总是返回而请求默认返回也可以使用装饰器来返回状态码可以在返回对象中通过来获取重定向将响应重定向到特定的使用装饰器如果想动态的决定状态码和可以在方法内返回一个对象完整示例服务提供者是用装饰器的类用于处理一些复杂的任务创建服务类中间件中间件在路由处理程序之前被调用可以访问请求对象和响应对象以及中间件函数中间件应该实现这个接口实现一个简单的中间件中间件执行完后需要执行应用中间件应用中间件必须使用模块类的方法来设置包含中间件的模块必须实现接口应用中间件要应用在整个应用的模块中即应用中间件排除路径为方法是的接口中间件不走这里监听这个路径这里的路径相当于中间件中的以上定义了一个中间件用于输出每个请求的请求方法和请求路径中间件会在应用模块中被消费模块自带一个方法可以使用单个中间件多个中间件可接受一个字符串多个字符串对象一个控制器多个控制器多个控制器用逗号分隔可以排除某些路由接受和对象多个用逗号分隔其中中的也支持路由通配符路径包含的所有都会通过这个中间件全局中间件一次性将中间件绑定到每个注册路由可以使用实例中的方法全局注册中间件异常过滤器内置的异常过滤器处理整个应用程序中的所有抛出异常一个完整的请求应该是以下步骤由客户端发起请求先经过过滤器处理再经过管道处理最终响应给服务简单的异常过滤器所有异常过滤器都应该实现通用的接口它需要你使用有效签名提供方法表示异常的类型获取响应信息获取请求信息获取异常状态获取异常信息绑定过滤器将单个过滤器绑定到某个的某个方法上需要使用到装饰器全局异常过滤器全局过滤器需要在入口文件中注册使用过滤器方法管道管道是具有装饰器的类管道要实现接口管道的两个典型应用场景转换管道将输入的数据转换为所需要的数据类型转换成验证对输入数据进行验证如果验证成功继续传递验证失败则抛出异常在以上两种情况下管道参数由控制器的路由进行处理会在调用这个方法之前插入一个管道管道会先拦截方法的调用参数进行转换或是验证处理管道示例以下示例使用管道是将中的参数由类型转换成类型请输入假设传入的路由是此时的参数值为过滤器会直接抛出错误防止了方法的继续执行自带的管道方法管道描述自定义管道是每个管道必须要实现的泛型接口泛型表明输入的的类型表明方法的返回类型每个管道必须声明方法接受两个参数是当前处理的方法参数被路由处理程序方法接收之前当前处理的方法参数的元数据守卫守卫类似于拦截器目的也是在请求响应周期的正确位置处理逻辑例如权限角色访问控制列表等通过守卫判断是否可以继续执行路由处理程序授权守卫当调用者通过了身份验证后常见的请求头添加才可以继续执行处理程序否则处理程序会被忽略注意每个守卫必须实现且必须实现一个方法此方法返回一个布尔值用于指示是否允许当前请求它可以同步或异步的返回响应继续处理用户调用将忽略当前的请求示例通过请求头是否有判断是否继续调用接口绑定守卫和管道拦截器一样守卫也是可以全局和局部的局部的守卫将使用装饰器设置一个控制范围的守卫这个装饰器可以使用单个参数也可以使用逗号分隔的参数列表多个守卫守护当前接口或者全局的守卫将使用为每个处理器设置角色假设一个控制器只对开放不对普通用户开放就需要灵活的设置处理器角色提供了通过装饰器将定制元数据附加到路由处理程序的能力假设现在有一个控制器通过守卫对服务进行守护自定义装饰器以上的意思是当使用自定义装饰器的时候注入的时候往传入一个参数在装饰器内通过设置一个元数据使得键为键值是传入的参数当使用自定义装饰器的时候就设置了一组数据数据是设置完成后在守卫内通过反射器通过相同的键名去反射对应的值守卫守卫必须实现的约束并且实现方法有唯一参数这里会自动映射在自定义装饰器内设置的元数据的键值以下逻辑根据需求自定义装饰器在中前端将需要传递的值加到请求对象然后在每个路由处理程序中手动提取它们就会变得非常麻烦为了方便可以自定义一个装饰器在所有的控制器中使用它假设现在自定义一个装饰器根据需求返回可以在其他地方直接使用参数装饰器装饰器描述传递数据也可以通过传递数据给自定义装饰器通过键从请求对象中提取属性如果存在该键则返回相关联的值如果不存在则返回假设请求对象中有一组数据根据需求返回在调用的时候通过传入一个键映射后返回一个值得存在返回值不存在返回鉴权身份认证客户端通过账号密码进行验证一旦通过验证服务器将发出生成一个在后续的请求中通过来验证身份还会创建一个仅对包含有效的保护路由策略提供了的策略它实现了用户名密码身份验证机制将它看作是一个框架框架内部已经帮你做了很多事情把很多验证机制都抽象了几个基本步骤安装依赖先创建模块这个单独的模块用来专门校验用户信息目录如下所有接口中分别由两个策略一个是不需要验证的接口比如登录接口一个是需要验证的业务接口所以出现了两个守卫其中需要从中导入校验用户是否存在校验用户登录用于生成密钥用的常量用户不存在创建模块这个模块专门用来从数据库中检索用户列表的操作这里的操作是通过检索用户列表的根据需求来走是对象关系映射器安装依赖',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-01 22:44:41',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">React</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://berniezwd.github.io/REACT_MARQUEE/" title="跑马灯"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/img/project/marquee.png" alt="跑马灯"/><span class="back-menu-item-text">跑马灯</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">有趣</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://berniezwd.github.io/PeopleJS/" title="人潮汹涌"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/img/project/people.png" alt="人潮汹涌"/><span class="back-menu-item-text">人潮汹涌</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">知瑾</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 即刻短文</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Docker/" style="font-size: 1.05rem; color: rgb(35, 83, 100);">Docker<sup>3</sup></a><a href="/tags/Html/" style="font-size: 1.05rem; color: rgb(133, 147, 8);">Html<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem; color: rgb(191, 4, 6);">JavaScript<sup>3</sup></a><a href="/tags/Jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" style="font-size: 1.05rem; color: rgb(99, 35, 143);">Jenkins自动化部署<sup>1</sup></a><a href="/tags/Nginx/" style="font-size: 1.05rem; color: rgb(26, 32, 158);">Nginx<sup>1</sup></a><a href="/tags/Pinia/" style="font-size: 1.05rem; color: rgb(119, 13, 60);">Pinia<sup>1</sup></a><a href="/tags/React/" style="font-size: 1.05rem; color: rgb(146, 141, 35); font-weight: 500; color: var(--anzhiyu-lighttext)">React<sup>4</sup></a><a href="/tags/Redux/" style="font-size: 1.05rem; color: rgb(21, 134, 159);">Redux<sup>1</sup></a><a href="/tags/TypeScript/" style="font-size: 1.05rem; color: rgb(96, 52, 182); font-weight: 500; color: var(--anzhiyu-lighttext)">TypeScript<sup>1</sup></a><a href="/tags/Vue/" style="font-size: 1.05rem; color: rgb(127, 76, 153);">Vue<sup>2</sup></a><a href="/tags/axios/" style="font-size: 1.05rem; color: rgb(62, 122, 16);">axios<sup>1</sup></a><a href="/tags/centOS/" style="font-size: 1.05rem; color: rgb(182, 159, 146);">centOS<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem; color: rgb(157, 166, 149);">css<sup>2</sup></a><a href="/tags/electron/" style="font-size: 1.05rem; color: rgb(153, 136, 118);">electron<sup>2</sup></a><a href="/tags/koa/" style="font-size: 1.05rem; color: rgb(173, 43, 171);">koa<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem; color: rgb(143, 71, 199);">mysql<sup>1</sup></a><a href="/tags/nestjs/" style="font-size: 1.05rem; color: rgb(10, 65, 156);">nestjs<sup>1</sup></a><a href="/tags/node/" style="font-size: 1.05rem; color: rgb(19, 121, 21);">node<sup>1</sup></a><a href="/tags/sass/" style="font-size: 1.05rem; color: rgb(198, 122, 32);">sass<sup>1</sup></a><a href="/tags/uniapp/" style="font-size: 1.05rem; color: rgb(135, 193, 106); font-weight: 500; color: var(--anzhiyu-lighttext)">uniapp<sup>1</sup></a><a href="/tags/vim/" style="font-size: 1.05rem; color: rgb(97, 182, 188);">vim<sup>1</sup></a><a href="/tags/vite/" style="font-size: 1.05rem; color: rgb(65, 69, 156);">vite<sup>1</sup></a><a href="/tags/vue/" style="font-size: 1.05rem; color: rgb(185, 47, 166);">vue<sup>1</sup></a><a href="/tags/vue3/" style="font-size: 1.05rem; color: rgb(16, 123, 90);">vue3<sup>1</sup></a><a href="/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1/" style="font-size: 1.05rem; color: rgb(18, 65, 192);">云服务<sup>1</sup></a><a href="/tags/%E5%8F%B3%E9%94%AEcmd/" style="font-size: 1.05rem; color: rgb(6, 27, 161);">右键cmd<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/" style="font-size: 1.05rem; color: rgb(189, 38, 8);">工具类<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 1.05rem; color: rgb(200, 46, 92);">开发环境搭建<sup>1</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E8%B7%AF%E7%94%B1/" style="font-size: 1.05rem; color: rgb(184, 37, 6);">文件路由<sup>1</sup></a><a href="/tags/%E6%A0%87%E7%AD%BE%E5%A4%96%E6%8C%82/" style="font-size: 1.05rem; color: rgb(100, 71, 155);">标签外挂<sup>1</sup></a><a href="/tags/%E9%9B%B6%E6%95%A3/" style="font-size: 1.05rem; color: rgb(152, 140, 6);">零散<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem; color: rgb(182, 100, 165);">面试<sup>1</sup></a><a href="/tags/%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA%E8%A7%84%E8%8C%83/" style="font-size: 1.05rem; color: rgb(135, 61, 77);">项目搭建规范<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">五月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/nestjs/" itemprop="url">nestjs</a></span></div></div><h1 class="post-title" itemprop="name headline">Nest.js</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2022-09-02T16:00:00.000Z" title="发表于 2022-09-03 00:00:00">2022-09-03</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-04-01T14:44:41.147Z" title="更新于 2023-04-01 22:44:41">2023-04-01</time></span></div><div class="meta-secondline"></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.zhimg.com%2Fv2-f6241353ba024915b991e8d5847b8da2_1440w.jpg%3Fsource%3D172ae18b&amp;refer=http%3A%2F%2Fpic1.zhimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1659410579&amp;t=a3fd1f73c15a8fe0f9b98e0520731d31"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2022/09/03/Nestjs/"><header><a class="post-meta-categories" href="/categories/nestjs/" itemprop="url">nestjs</a><h1 id="CrawlerTitle" itemprop="name headline">Nest.js</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">知瑾</span><time itemprop="dateCreated datePublished" datetime="2022-09-02T16:00:00.000Z" title="发表于 2022-09-03 00:00:00">2022-09-03</time><time itemprop="dateCreated datePublished" datetime="2023-04-01T14:44:41.147Z" title="更新于 2023-04-01 22:44:41">2023-04-01</time></header><h1 id="Nestjs"><a href="#Nestjs" class="headerlink" title="Nestjs"></a>Nestjs</h1><h2 id="创建-Nestjs-项目"><a href="#创建-Nestjs-项目" class="headerlink" title="创建 Nestjs 项目"></a>创建 Nestjs 项目</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i -g @nestjs/cli</span><br><span class="line">nest new project-name</span><br></pre></td></tr></table></figure>

<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>模块是使用<code>@Module</code>装饰器的类，<code>@Module</code>装饰器提供元数据，Nest 应用是很多模块组成。一个应用至少有一个模块。</p>
<p><code>@Module</code>装饰器接受 4 个属性：</p>
<ul>
<li>providers：向模块注入实例化的提供者，可以在整个模块中共享数据</li>
<li>controllers：控制器（必须创建）</li>
<li>imports：导入其他模块的列表</li>
<li>exports：导出当前模块，供其他模块使用</li>
</ul>
<div class="note primary no-icon flat"><p>创建模块</p>
<p>$ nest g module cats</p>
</div>

<p>使用命令创建的模块会自动注入到<code>根模块</code>，创建模块后到目录：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├──cats</span><br><span class="line">│    ├──dto</span><br><span class="line">│    │   └──create-cat.dto.ts</span><br><span class="line">│    ├──interfaces</span><br><span class="line">│    │     └──cat.interface.ts</span><br><span class="line">│    ├─cats.service.ts</span><br><span class="line">│    ├─cats.controller.ts</span><br><span class="line">│    └──cats.module.ts</span><br><span class="line">├──app.module.ts</span><br><span class="line">└──main.ts</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h3><p>一个模块有对应的<code>controller</code>和<code>service</code>层，应该封装在一个功能模块下。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">CatsController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">CatsService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="共享模块"><a href="#共享模块" class="headerlink" title="共享模块"></a>共享模块</h3><p>默认情况下：<code>模块是单例</code>，所以可以在多个模块中共享<code>同一个模块实例</code>。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/Users/zwd/Library/Application Support/typora-user-images/image-20220905101537340.png" alt="image-20220905101537340" style="zoom:50%;" />

<p>当模块需要被其他模块共享时，需要将模块放到当前模块的<code>exports</code>中，在应用模块中在<code>imports</code>定义。</p>
<p>模块共享可以在<code>controller</code>控制层相互调用<code>service</code>：</p>
<p>例如：在狗的模块中调用猫的模块。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DogsService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./dogs.service&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CatsService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../cats/cats.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;dogs&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DogsController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> dogService: DogsService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> catService: CatsService</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">dogAskCatName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getCatName</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><p><code>Service</code>也可以注入到<code>Module</code>中，一般用于<code>配置信息目的</code>。</p>
<p>相反不可以将<code>Module</code>注入到<code>Service</code>中。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">CatsController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">CatsService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsModule</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> catsService: CatsService</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全局模块"><a href="#全局模块" class="headerlink" title="全局模块"></a>全局模块</h3><p>Nest 提供一种全局模块，无需每个模块都导入一遍。（<code>通常会将helper、数据库连接等全局导入，随时随地使用</code>）。</p>
<p>需要使用<code>@Global</code>装饰器，使其成为全局模块，在核心模块中注册，这种全局模块注册后，在别的模块中不需要使用<code>imports</code>导入。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span>, <span class="title class_">Global</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CatsController</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./cats.controller&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CatsService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./cats.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Global</span>()</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">CatsController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">CatsService</span>],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">CatsService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h2><p>控制器负责处理<code>传入的请求</code>和<code>向客户端返回响应</code>。</p>
<p>控制器的目的是接受<code>特定请求</code>，每个控制器有多个路由，每个路由执行不同的操作。</p>
<p>控制器使用<code>@Controller</code>装饰器定义。</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><div class="note primary no-icon flat"><p>创建路由</p>
<p>$ nest g controller cats</p>
</div>

<p>在<code>@Controller()</code>中使用路径前缀可以对一组相关的路由进行分组。</p>
<p>@Controller(‘cats’) 代表 cat 模块的路由有个前缀<code>/cats</code>，任何在 cats 模块中的路由，都需要添加<code>/cats</code>来访问。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CatsService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./cats.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;cats&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> catService: CatsService</span>) &#123;&#125;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">getCatName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getCatName</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * 匹配的路由是 --&gt; /cats/detail</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&quot;detail&quot;</span>)</span><br><span class="line">  <span class="title function_">getDetail</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getDetail</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * 通配参数 --&gt; category_123 、 category_abc</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&quot;category_*&quot;</span>)</span><br><span class="line">  <span class="title function_">getCategory</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getCategory</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 动态参数 --&gt; color/123 、 color/abc</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&quot;color/:id&quot;</span>)</span><br><span class="line">  <span class="title function_">getColor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getColor</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>路由方式还包括了<code>@Get()、@Put()、@Delete()、@Patch()</code></p>
<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><div class="note primary no-icon flat"><p>为了在<code>express</code>中使用<code>Typescript</code>，请安装<code>@types/express</code></p>
</div>

<p>Nest 提供了对底层平台的请求对象(基于<code>Express</code>)的访问方式。</p>
<p>可以在处理函数签名中使用<code>@Req()</code>装饰器，指示 Nest 将请求对象注入函数中。</p>
<p><code>request</code>请求具有<code>查询字符串、请求参数、Http header标头、Http body</code>的属性。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">getCatName</span>(<span class="params"><span class="meta">@Req</span>() req:Request</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🚀🚀🚀🚀🚀🚀 --&gt;&#x27;</span>, req)</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getCatName</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">方法</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>@Request()，@Req()</code></td>
<td align="left"><code>req</code></td>
</tr>
<tr>
<td align="left"><code>@Response()，@Res()*</code></td>
<td align="left"><code>res</code></td>
</tr>
<tr>
<td align="left"><code>@Next()</code></td>
<td align="left"><code>next</code></td>
</tr>
<tr>
<td align="left"><code>@Session()</code></td>
<td align="left"><code>req.session</code></td>
</tr>
<tr>
<td align="left"><code>@Param(key?: string)</code></td>
<td align="left"><code>req.params</code>&#x2F;<code>req.params[key]</code></td>
</tr>
<tr>
<td align="left"><code>@Body(key?: string)</code></td>
<td align="left"><code>req.body</code>&#x2F;<code>req.body[key]</code></td>
</tr>
<tr>
<td align="left"><code>@Query(key?: string)</code></td>
<td align="left"><code>req.query</code>&#x2F;<code>req.query[key]</code></td>
</tr>
<tr>
<td align="left"><code>@Headers(name?: string)</code></td>
<td align="left"><code>req.headers</code>&#x2F;<code>req.headers[name]</code></td>
</tr>
<tr>
<td align="left"><code>@Ip()</code></td>
<td align="left"><code>req.ip</code></td>
</tr>
<tr>
<td align="left"><code>@HostParam()</code></td>
<td align="left"><code>req.hosts</code></td>
</tr>
</tbody></table>
<p>假设路由携带 id 参数: <code>http://localhost:3000/cats?id=123</code>，那么<code>@Query(id)</code>中的值就是<code>123</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">getCatName</span>(<span class="params"><span class="meta">@Req</span>() request:Request, <span class="meta">@Query</span>(<span class="string">&#x27;id&#x27;</span>) id</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🚀🚀🚀🚀🚀🚀 --&gt;&#x27;</span>, id)</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getCatName</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h3><p>默认情况下接口总是返回<code>200</code>，而<code>post</code>请求默认返回<code>201</code>，也可以使用<code>@HttpCode()</code>装饰器来返回状态码，可以在<code>response</code>返回对象中，通过<code>statusCode</code>来获取：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line"><span class="meta">@HttpCode</span>(<span class="number">300</span>)</span><br><span class="line"><span class="title function_">getPostStatusCode</span>(<span class="params"><span class="meta">@Res</span>() res:Response</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🚀🚀🚀🚀🚀🚀 --&gt; 300&#x27;</span>, res.<span class="property">statusCode</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catService</span>.<span class="title function_">getPostStatusCode</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p>将响应重定向到特定的<code>Url</code>，使用<code>@Redirect()</code>装饰器</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;userRole&#x27;</span>)</span><br><span class="line"><span class="meta">@Redirect</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>, <span class="number">301</span>)</span><br><span class="line"><span class="title function_">redirectUrl</span>(<span class="params"></span>)&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果想动态的决定<code>HTTP状态码</code>和<code>Url</code>，可以在方法内返回一个对象</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;userRole&#x27;</span>)</span><br><span class="line"><span class="meta">@Redirect</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>, <span class="number">301</span>)</span><br><span class="line"><span class="title function_">redirectUrl</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">url</span>:<span class="string">&#x27;https://berniezhong.gitee.io/buttferfly-bernie/&#x27;</span>,</span><br><span class="line">    <span class="attr">statusCode</span>: <span class="number">304</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* cats.controller.ts */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Get</span>,</span><br><span class="line">  <span class="title class_">Query</span>,</span><br><span class="line">  <span class="title class_">Post</span>,</span><br><span class="line">  <span class="title class_">Body</span>,</span><br><span class="line">  <span class="title class_">Put</span>,</span><br><span class="line">  <span class="title class_">Param</span>,</span><br><span class="line">  <span class="title class_">Delete</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateCatDto</span>, <span class="title class_">UpdateCatDto</span>, <span class="title class_">ListAllEntities</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./dto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;cats&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsController</span> &#123;</span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="title function_">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;This action adds a new cat&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"><span class="meta">@Query</span>() query: ListAllEntities</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action returns all cats (limit: <span class="subst">$&#123;query.limit&#125;</span> items)`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&quot;:id&quot;</span>)</span><br><span class="line">  <span class="title function_">findOne</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&quot;id&quot;</span>) id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action returns a #<span class="subst">$&#123;id&#125;</span> cat`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Put</span>(<span class="string">&quot;:id&quot;</span>)</span><br><span class="line">  <span class="title function_">update</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&quot;id&quot;</span>) id: <span class="built_in">string</span>, <span class="meta">@Body</span>() updateCatDto: UpdateCatDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action updates a #<span class="subst">$&#123;id&#125;</span> cat`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">&quot;:id&quot;</span>)</span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&quot;id&quot;</span>) id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action removes a #<span class="subst">$&#123;id&#125;</span> cat`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h2><p>提供者是用<code>@Injectable()</code>装饰器的类，用于处理一些复杂的任务。</p>
<div class="note primary no-icon flat"><p>创建服务类</p>
<p>$ nest g service cats</p>
</div>

<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>中间件在路由处理程序之前被调用，可以访问<code>请求对象</code>和<code>响应对象</code>，以及<code>next()</code>中间件函数，<code>Nest</code>中间件应该实现<code>NestMiddleware</code>这个接口。</p>
<p>实现一个简单的中间件：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">NestMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span>, <span class="title class_">NextFunction</span> &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoggerMiddleware</span> <span class="keyword">implements</span> <span class="title class_">NestMiddleware</span> &#123;</span><br><span class="line">  <span class="title function_">use</span>(<span class="params">req: Request, res: Response, next: NextFunction</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; path, method &#125; = req;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🚀🚀🚀🚀🚀🚀 --&gt;&quot;</span>, <span class="string">`<span class="subst">$&#123;path&#125;</span> <span class="subst">$&#123;method&#125;</span> `</span>);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中间件执行完后需要执行<code>next()</code></p>
<h3 id="应用中间件"><a href="#应用中间件" class="headerlink" title="应用中间件"></a>应用中间件</h3><p>应用中间件必须使用模块类的<code>configure()</code>方法来设置，包含中间件的模块必须实现<code>NestModule</code>接口，应用中间件要应用在整个应用的模块中，即：<code>app.module.ts</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MiddlewareConsumer</span>, <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CatsModule</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./cats/cats.module&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggerMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./common/logger.middleware&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">CatsModule</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;</span><br><span class="line">  <span class="title function_">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>) &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .<span class="title function_">apply</span>(<span class="title class_">LoggerMiddleware</span>) <span class="comment">/** 应用中间件 */</span></span><br><span class="line">      .<span class="title function_">exclude</span>(&#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="title class_">RequestMethod</span>.<span class="property">POST</span>,</span><br><span class="line">      &#125;) <span class="comment">/** 排除路径为`hello`，方法是POST的接口(中间件不走这里) */</span></span><br><span class="line">      .<span class="title function_">forRoutes</span>(</span><br><span class="line">        <span class="string">&quot;cats&quot;</span></span><br><span class="line">      ); <span class="comment">/** 监听cats这个路径，这里的路径相当于中间件中的path */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上：定义了一个<code>LoggerMiddleware</code>中间件，用于输出每个请求的请求方法和请求路径，中间件会在应用模块中被消费，模块自带一个<code>configure</code>方法。</p>
<div class="note primary no-icon flat"><p><code>apply()</code>可以使用单个中间件、多个中间件</p>
<p><code>forRoutes()</code>可接受一个字符串、多个字符串、对象、一个控制器、多个控制器(多个控制器用逗号分隔)</p>
<p><code>exclude()</code>可以排除某些路由，接受<code>path</code>和<code>method</code>对象，多个用逗号分隔</p>
</div>

<p>其中<code>forRoutes</code>中的<code>path</code>也支持<code>路由通配符</code>，路径包含<code>ab*cd</code>的所有<code>method</code>，都会通过这个中间件</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">forRoutes</span>(&#123; <span class="attr">path</span>: <span class="string">&quot;ab*cd&quot;</span>, <span class="attr">method</span>: <span class="title class_">RequestMethod</span>.<span class="property">ALL</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="全局中间件"><a href="#全局中间件" class="headerlink" title="全局中间件"></a>全局中间件</h3><p>一次性将中间件绑定到每个注册路由，可以使用<code>INestApplication</code>实例中的<code>use()</code>方法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">app.<span class="title function_">use</span>(logger); <span class="comment">/** 全局注册中间件 */</span></span><br><span class="line"><span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h2 id="异常过滤器"><a href="#异常过滤器" class="headerlink" title="异常过滤器"></a>异常过滤器</h2><p>内置的<code>异常过滤器</code>处理整个应用程序中的所有抛出异常。</p>
<p>一个完整的请求应该是以下步骤：</p>
<p>由客户端发起请求，先经过过滤器处理，再经过管道处理，最终响应给服务。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/Users/zwd/Library/Application Support/typora-user-images/image-20220906102202657.png" alt="image-20220906102202657" style="zoom:50%;" />

<h3 id="简单的异常过滤器"><a href="#简单的异常过滤器" class="headerlink" title="简单的异常过滤器"></a>简单的异常过滤器</h3><div class="note primary no-icon flat"><p>所有异常过滤器都应该实现通用的 <code>ExceptionFilter&lt;T&gt;</code> 接口。它需要你使用有效签名提供 <code>catch(exception: T, host: ArgumentsHost)</code>方法。<code>T</code> 表示异常的类型。</p>
</div>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">ArgumentsHost</span>,</span><br><span class="line">  <span class="title class_">Catch</span>,</span><br><span class="line">  <span class="title class_">ExceptionFilter</span>,</span><br><span class="line">  <span class="title class_">HttpException</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Catch</span>(<span class="title class_">HttpException</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpExceptionFilter</span> <span class="keyword">implements</span> <span class="title class_">ExceptionFilter</span>&lt;<span class="title class_">HttpException</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">catch</span>(<span class="attr">exception</span>: <span class="title class_">HttpException</span>, <span class="attr">host</span>: <span class="title class_">ArgumentsHost</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = host.<span class="title function_">switchToHttp</span>(),</span><br><span class="line">      response = ctx.<span class="title function_">getResponse</span>() <span class="comment">/** 获取响应信息 */</span>,</span><br><span class="line">      request = ctx.<span class="title function_">getRequest</span>() <span class="comment">/** 获取请求信息 */</span>,</span><br><span class="line">      status = exception.<span class="title function_">getStatus</span>() <span class="comment">/** 获取异常状态 */</span>,</span><br><span class="line">      <span class="attr">exceptionRes</span>: <span class="built_in">any</span> = exception.<span class="title function_">getResponse</span>(); <span class="comment">/** 获取异常信息 */</span></span><br><span class="line">    <span class="keyword">const</span> &#123; error, message &#125; = exceptionRes;</span><br><span class="line"></span><br><span class="line">    response.<span class="title function_">status</span>(status).<span class="title function_">json</span>(&#123;</span><br><span class="line">      status,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">      <span class="attr">path</span>: request.<span class="property">url</span>,</span><br><span class="line">      error,</span><br><span class="line">      message,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绑定过滤器"><a href="#绑定过滤器" class="headerlink" title="绑定过滤器"></a>绑定过滤器</h3><p>将单个过滤器绑定到某个<code>Controller</code>的某个方法上，需要使用到<code>@UseFilters()</code>装饰器：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@UseFilters</span>(<span class="keyword">new</span> <span class="title class_">HttpExceptionFilter</span>())</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ForbiddenException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全局异常过滤器"><a href="#全局异常过滤器" class="headerlink" title="全局异常过滤器"></a>全局异常过滤器</h3><p>全局过滤器需要在入口文件<code>main.ts</code>中注册，使用<code>app.useGlobalFilters(过滤器)</code>方法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  app.<span class="title function_">useGlobalFilters</span>(<span class="keyword">new</span> <span class="title class_">HttpExceptionFilter</span>());</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>管道是具有<code>@Injectable()</code>装饰器的类，管道要实现<code>PipeTransform</code>接口。</p>
<p>管道的两个典型应用场景：</p>
<ul>
<li>转换： 管道将输入的数据转换为所需要的数据类型（string 转换成 number）</li>
<li>验证：对输入数据进行验证，如果验证成功继续传递，验证失败则抛出异常</li>
</ul>
<p>在以上两种情况下，管道参数由<code>控制器Controller的路由</code>进行处理。<code>Nest</code>会在调用这个方法之前插入一个管道，管道会先拦截方法的调用参数，进行转换或是验证处理。</p>
<h3 id="管道示例"><a href="#管道示例" class="headerlink" title="管道示例"></a>管道示例</h3><p>以下示例使用<code>new ParseIntPipe()</code>管道，是将<code>Param</code>中的参数 id，由<code>String类型</code>转换成<code>Number类型</code>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Patch</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line"><span class="meta">@ApiOperation</span>(&#123;<span class="attr">summary</span>: <span class="string">&#x27;PATCH&#x27;</span>&#125;)</span><br><span class="line"><span class="meta">@ApiParam</span>(&#123;<span class="attr">name</span>:<span class="string">&#x27;id&#x27;</span>&#125;)</span><br><span class="line"><span class="meta">@ApiParam</span>(&#123;<span class="attr">name</span>:<span class="string">&#x27;message&#x27;</span>&#125;)</span><br><span class="line"><span class="meta">@ApiBody</span>(&#123;<span class="attr">description</span>:<span class="string">&#x27;请输入message&#x27;</span>&#125;)</span><br><span class="line"><span class="title function_">update</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>, <span class="keyword">new</span> ParseIntPipe()) id, <span class="meta">@Body</span>() &#123;message&#125;</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🚀🚀🚀🚀🚀🚀id&#x27;</span>, <span class="keyword">typeof</span> id)</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">exceptionService</span>.<span class="title function_">update</span>(id, message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设传入的路由是<code>localhost:3000/exception/abc</code>，此时<code>Param</code>的参数 id，值为<code>abc</code>：</p>
<p>过滤器会直接抛出错误，防止了<code>update()</code>方法的继续执行：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;statusCode&quot;</span>: <span class="number">400</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Validation failed (numeric string is expected)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: <span class="string">&quot;Bad Request&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自带的<code>Parse*</code>管道方法：</p>
<table>
<thead>
<tr>
<th>管道</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>ValidationPipe</code></td>
<td></td>
</tr>
<tr>
<td><code>ParseIntPipe</code></td>
<td></td>
</tr>
<tr>
<td><code>ParseFloatPipe</code></td>
<td></td>
</tr>
<tr>
<td><code>ParseBoolPipe</code></td>
<td></td>
</tr>
<tr>
<td><code>ParseArrayPipe</code></td>
<td></td>
</tr>
<tr>
<td><code>ParseUUIDPipe</code></td>
<td></td>
</tr>
<tr>
<td><code>ParseEnumPipe</code></td>
<td></td>
</tr>
<tr>
<td><code>DefaultValuePipe</code></td>
<td></td>
</tr>
<tr>
<td><code>ParseFilePipe</code></td>
<td></td>
</tr>
</tbody></table>
<h3 id="自定义管道"><a href="#自定义管道" class="headerlink" title="自定义管道"></a>自定义管道</h3><div class="note info no-icon flat"><p>validation.pipe.ts</p>
<p>PipeTransform&lt;T, R&gt;是每个管道必须要实现的泛型接口，泛型<code>T</code>表明输入的<code>value</code>的类型，<code>R</code>表明<code>transfrom()</code>方法的返回类型</p>
</div>

<p>每个管道必须声明<code>transfrom()</code>方法，接受两个参数：</p>
<ul>
<li><code>value</code>：是当前处理的方法参数（被路由处理程序方法接收之前）</li>
<li><code>metadata</code>：当前处理的方法参数的元数据。</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PipeTransform</span>, <span class="title class_">Injectable</span>, <span class="title class_">ArgumentMetadata</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ValidationPipe</span> <span class="keyword">implements</span> <span class="title class_">PipeTransform</span> &#123;</span><br><span class="line">  <span class="title function_">transform</span>(<span class="params">value: <span class="built_in">any</span>, metadata: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="守卫"><a href="#守卫" class="headerlink" title="守卫"></a>守卫</h2><p>守卫类似于拦截器，目的也是在请求&#x2F;响应周期的正确位置处理逻辑，例如（<code>权限</code>、<code>角色</code>、<code>访问控制列表</code>）等。</p>
<p>通过守卫判断是否可以继续执行路由处理程序。</p>
<h3 id="授权守卫"><a href="#授权守卫" class="headerlink" title="授权守卫"></a>授权守卫</h3><p>当调用者通过了身份验证后（常见的请求头添加<code>token</code>），才可以继续执行处理程序，否则处理程序会被忽略。</p>
<p>注意：</p>
<p>每个守卫必须实现<code>CanActivate</code>，且必须实现一个<code>canActive()</code>方法，此方法返回一个<code>布尔值</code>，用于指示是否允许当前请求，它可以同步或异步(<code>Promise</code>)的返回响应。</p>
<ul>
<li>true：继续处理用户调用</li>
<li>false：将忽略当前的请求</li>
</ul>
<p>示例：通过请求头是否有<code>token</code>判断是否继续调用接口：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">CanActivate</span>, <span class="title class_">ExecutionContext</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">RolesGuard</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">canActivate</span>(<span class="params">ctx: ExecutionContext</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> req = ctx.<span class="title function_">switchToHttp</span>().<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="keyword">return</span> req.<span class="property">headers</span>.<span class="property">token</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绑定守卫"><a href="#绑定守卫" class="headerlink" title="绑定守卫"></a>绑定守卫</h3><p>和管道、拦截器一样，守卫也是可以全局和局部的。</p>
<p>局部的守卫将使用<code>@UseGuards()</code>装饰器设置一个控制范围的守卫。这个装饰器可以使用单个参数，也可以使用逗号分隔的参数列表(多个守卫守护当前接口)。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;cats&quot;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="keyword">new</span> <span class="title class_">RolesGuard</span>()) <span class="comment">/** 或者<span class="doctag">@UseGuards</span>(RolesGuard)*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsController</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>全局的守卫将使用<code>useGlobalGuards()</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">app.<span class="title function_">useGlobalGuards</span>(<span class="keyword">new</span> <span class="title class_">RolesGuard</span>());</span><br></pre></td></tr></table></figure>

<h3 id="为每个处理器设置角色"><a href="#为每个处理器设置角色" class="headerlink" title="为每个处理器设置角色"></a>为每个处理器设置角色</h3><p>假设一个控制器只对<code>admin</code>开放，不对<code>local</code>普通用户开放，就需要灵活的设置处理器角色。</p>
<p><code>Nest</code>提供了通过<code>@SetMetadata()</code>装饰器将定制元数据附加到路由处理程序的能力。</p>
<p>假设现在有一个<code>guard</code>控制器：通过<code>RolesGuard</code>守卫对服务进行守护</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&quot;guard&quot;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;guard&quot;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RolesGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> guardService: GuardService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">fetch</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;id&quot;</span>) id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">fetch</span>(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="meta">@Roles</span>(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">  <span class="title function_">postWithNoGuard</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`no token success`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note info no-icon flat"><p>自定义装饰器<code>@Roles()</code></p>
<p>role.decorator.ts</p>
</div>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SetMetadata</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">Roles</span> = (<span class="params">...roles: <span class="built_in">string</span>[]</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">SetMetadata</span>(<span class="string">&quot;roles&quot;</span>, roles);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>以上的意思是：当使用自定义装饰器的时候，注入<code>@Roles()</code>的时候，往<code>@Roles(&#39;admin&#39;)</code>传入一个参数，在<code>Roles</code>装饰器内通过<code>SetMetadata</code>设置一个元数据。使得键为<code>roles</code>，键值是传入的参数，当使用自定义装饰器的时候<code>@Roles(&#39;admin&#39;)</code>，就设置了一组数据，数据是<code>&#123;roles: [admins]&#125;</code>，设置完成后，在守卫内通过<code>reflector</code>反射器，通过相同的键名去反射对应的值。</p>
<div class="note info no-icon flat"><p><code>RolesGuard</code>守卫</p>
<p>role.guard.ts</p>
</div>

<p>守卫必须实现<code>CanActivate</code>的约束，并且实现<code>canActivate()</code>方法，<code>canActivate()</code>有唯一参数<code>ctx</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">CanActivate</span>, <span class="title class_">ExecutionContext</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Reflector</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/core&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">RolesGuard</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> reflector: Reflector</span>) &#123;&#125;</span><br><span class="line">  <span class="title function_">canActivate</span>(<span class="params">ctx: ExecutionContext</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> roles = <span class="variable language_">this</span>.<span class="property">reflector</span>.<span class="title function_">get</span>(</span><br><span class="line">      <span class="string">&quot;roles&quot;</span>,</span><br><span class="line">      ctx.<span class="title function_">getHandler</span>()</span><br><span class="line">    ); <span class="comment">/** 这里会自动映射在自定义装饰器内设置的元数据的键值 */</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;🚀&quot;</span>, roles);</span><br><span class="line">    <span class="keyword">if</span> (!roles) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 以下逻辑根据需求 */</span></span><br><span class="line">    <span class="keyword">const</span> req = ctx.<span class="title function_">switchToHttp</span>().<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123; user &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !!roles.<span class="title function_">find</span>(<span class="function">(<span class="params">role</span>) =&gt;</span> role == user);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义装饰器"><a href="#自定义装饰器" class="headerlink" title="自定义装饰器"></a>自定义装饰器</h2><p>在 node 中，前端将需要传递的值加到请求对象，然后在每个路由处理程序中手动提取它们，就会变得非常麻烦。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> token = req.<span class="property">headers</span>.<span class="property">token</span>;</span><br></pre></td></tr></table></figure>

<p>为了方便，可以自定义一个装饰器，在所有的控制器中使用它，假设现在自定义一个<code>@Token()</code>装饰器：</p>
<div class="note info no-icon flat"><p>token.decorator.ts</p>
</div>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createParamDecorator, <span class="title class_">ExecutionContext</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Token</span> = <span class="title function_">createParamDecorator</span>(</span><br><span class="line">  <span class="function">(<span class="params">data: <span class="built_in">unknown</span>, ctx: ExecutionContext</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> request = ctx.<span class="title function_">switchToHttp</span>().<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="keyword">return</span> request.<span class="property">headers</span>.<span class="property">token</span>; <span class="comment">/** 根据需求返回 */</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>可以在其他地方直接使用：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findOne</span>(<span class="params"><span class="meta">@Token</span>() token: TokenEntity</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参数装饰器"><a href="#参数装饰器" class="headerlink" title="参数装饰器"></a>参数装饰器</h3><table>
<thead>
<tr>
<th align="left">装饰器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>@Response()，@Res()</code></td>
<td><code>res</code></td>
</tr>
<tr>
<td align="left"><code>@Request()，@Req()</code></td>
<td><code>req</code></td>
</tr>
<tr>
<td align="left"><code>@Next()</code></td>
<td><code>next</code></td>
</tr>
<tr>
<td align="left"><code>@Session()</code></td>
<td><code>req.session</code></td>
</tr>
<tr>
<td align="left"><code>@Param(param?: string)</code></td>
<td><code>req.params / req.params[param]</code></td>
</tr>
<tr>
<td align="left"><code>@Body(param?: string)</code></td>
<td><code>req.body / req.body[param]</code></td>
</tr>
<tr>
<td align="left"><code>@Query(param?: string)</code></td>
<td><code>req.query / req.query[param]</code></td>
</tr>
<tr>
<td align="left"><code>@Headers(param?: string)</code></td>
<td><code>req.headers / req.headers[param]</code></td>
</tr>
<tr>
<td align="left"><code>@Ip()</code></td>
<td><code>req.ip</code></td>
</tr>
<tr>
<td align="left"><code>@HostParam()</code></td>
<td><code>req.hosts</code></td>
</tr>
</tbody></table>
<h3 id="传递数据"><a href="#传递数据" class="headerlink" title="传递数据"></a>传递数据</h3><p>也可以通过传递数据给自定义装饰器，通过键从请求对象中提取属性。如果存在该键，则返回<code>相关联的值</code>，如果不存在，则返回<code>undefined</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createParamDecorator, <span class="title class_">ExecutionContext</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">FirstName</span> = <span class="title function_">createParamDecorator</span>(</span><br><span class="line">  <span class="function">(<span class="params">data: <span class="built_in">string</span>, ctx: ExecutionContext</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> request = ctx.<span class="title function_">switchToHttp</span>().<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	假设request请求对象中有一组user数据：</span></span><br><span class="line"><span class="comment">  	&#123;</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 101,</span></span><br><span class="line"><span class="comment">      &quot;firstName&quot;: &quot;Alan&quot;,</span></span><br><span class="line"><span class="comment">      &quot;lastName&quot;: &quot;Turing&quot;,</span></span><br><span class="line"><span class="comment">      &quot;email&quot;: &quot;alan@email.com&quot;,</span></span><br><span class="line"><span class="comment">      &quot;roles&quot;: [&quot;admin&quot;]</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">    <span class="keyword">return</span> request.<span class="property">user</span>[data]; <span class="comment">/** 根据需求返回 */</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在调用的时候通过传入一个键，映射后返回一个值得，存在返回值，不存在返回 undefined</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findOne</span>(<span class="params"><span class="meta">@FirstName</span>(<span class="string">&#x27;firstName&#x27;</span>) firstName: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(firstName); <span class="comment">/** Alan */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Jwt-鉴权"><a href="#Jwt-鉴权" class="headerlink" title="Jwt 鉴权"></a>Jwt 鉴权</h2><h3 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h3><p>客户端通过账号密码进行验证，一旦通过验证，服务器将发出<code>JWT</code>，<code>JWT</code>生成一个<code>token</code>，在后续的请求中通过<code>token</code>来验证身份，还会创建一个仅对包含有效<code>JWT</code>的保护路由。</p>
<p><code>Passport策略</code></p>
<p>passport 提供了<code>Passport-local</code>的策略，它实现了<code>用户名/密码</code>身份验证机制，将它看作是一个框架，框架内部已经帮你做了很多事情，把很多验证机制都抽象了几个基本步骤。</p>
<p>安装<code>passport</code>依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install --save @nestjs/passport passport passport-local</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install --save-dev @types/passport-local</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>先创建<code>auth</code>模块，<code>auth</code>这个单独的模块用来专门校验用户信息，目录如下：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├──auth</span><br><span class="line">│    ├──auth.controller.ts</span><br><span class="line">│    ├──auth.module.ts</span><br><span class="line">│    ├──auth.service.ts</span><br><span class="line">│    ├──jwt.strategy.ts</span><br><span class="line">│    ├──local.strategy.ts</span><br><span class="line">│    ├──constants.ts</span><br><span class="line">├──user</span><br><span class="line">│    ├──user.module.ts</span><br><span class="line">│    ├──user.service.ts</span><br><span class="line">├──app.module.ts</span><br><span class="line">└──main.ts</span><br></pre></td></tr></table></figure>

<p>所有接口中，分别由两个策略，一个是不需要<code>JWT</code>验证的接口，比如登录接口，一个是需要<code>JWT</code>验证的业务接口。</p>
<p>所以出现了两个守卫：<code>@UseGuards(AuthGuard(&#39;local&#39;))</code>、<code>@UseGuards(AuthGuard(&#39;jwt&#39;))</code>，其中<code>AuthGuard</code>需要从<code>@nestjs/passport</code>中导入。</p>
<div class="note warning flat"><p>auth.controller.ts</p>
</div>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span>, <span class="title class_">Post</span>, <span class="title class_">Request</span>, <span class="title class_">UseGuards</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./auth.service&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthGuard</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/passport&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;auth&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> authService: AuthService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">AuthGuard</span>(<span class="string">&quot;local&quot;</span>))</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"><span class="meta">@Request</span>() req</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">login</span>(req.<span class="property">user</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">AuthGuard</span>(<span class="string">&quot;jwt&quot;</span>))</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&quot;profile&quot;</span>)</span><br><span class="line">  <span class="title function_">getProfile</span>(<span class="params"><span class="meta">@Request</span>() req</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> req.<span class="property">user</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note warning flat"><p>auth.service.ts</p>
</div>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/jwt&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UsersService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../users/users.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> userService: UsersService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> jwtService: JwtService</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 校验用户是否存在 */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">validateUser</span>(<span class="attr">username</span>: <span class="built_in">string</span>, <span class="attr">pwd</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">findOne</span>(username);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;校验用户&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (user &amp;&amp; user.<span class="property">password</span> === pwd) &#123;</span><br><span class="line">      <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 登录 */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">user: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> payload = &#123; <span class="attr">username</span>: user.<span class="property">username</span>, <span class="attr">sub</span>: user.<span class="property">userId</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">access_token</span>: <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">sign</span>(payload),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note warning flat"><p>jwt.strategy.ts</p>
</div>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ExtractJwt</span>, <span class="title class_">Strategy</span> &#125; <span class="keyword">from</span> <span class="string">&quot;passport-jwt&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PassportStrategy</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/passport&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; jwtConstants &#125; <span class="keyword">from</span> <span class="string">&quot;./constants&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JwtStrategy</span> <span class="keyword">extends</span> <span class="title class_ inherited__">PassportStrategy</span>(<span class="title class_">Strategy</span>) &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(&#123;</span><br><span class="line">      <span class="attr">jwtFromRequest</span>: <span class="title class_">ExtractJwt</span>.<span class="title function_">fromAuthHeaderAsBearerToken</span>(),</span><br><span class="line">      <span class="attr">ignoreExpiration</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">secretOrKey</span>: jwtConstants.<span class="property">secret</span> <span class="comment">/**用于生成密钥用的常量*/</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">validate</span>(<span class="params">payload: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">userId</span>: payload.<span class="property">sub</span>, <span class="attr">username</span>: payload.<span class="property">username</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note warning flat"><p>local.strategy.ts</p>
</div>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Strategy</span> &#125; <span class="keyword">from</span> <span class="string">&quot;passport-local&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PassportStrategy</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/passport&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./auth.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LocalStrategy</span> <span class="keyword">extends</span> <span class="title class_ inherited__">PassportStrategy</span>(<span class="title class_">Strategy</span>) &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> authService: AuthService</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">validate</span>(<span class="attr">username</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">validateUser</span>(username, password);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&quot;🙅用户不存在🙅&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>user</code>模块，<code>user</code>这个模块专门用来从数据库中检索用户列表的操作：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">User</span> = <span class="built_in">any</span>;</span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UsersService</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="attr">users</span>: <span class="title class_">User</span>[];</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">users</span> = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">userId</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;john&quot;</span>,</span><br><span class="line">        <span class="attr">password</span>: <span class="string">&quot;changeme&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">userId</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;chris&quot;</span>,</span><br><span class="line">        <span class="attr">password</span>: <span class="string">&quot;secret&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">userId</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;maria&quot;</span>,</span><br><span class="line">        <span class="attr">password</span>: <span class="string">&quot;guess&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">findOne</span>(<span class="params">username: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="comment">/** 这里的操作是通过typeorm检索用户列表的 根据需求来走*/</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">users</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">user</span>) =&gt;</span> user.<span class="property">username</span> === username);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/Users/zwd/Library/Application Support/typora-user-images/image-20220908142230800.png" alt="image-20220908142230800" style="zoom:50%;" /></li>
</ol>
<h2 id="TypeORM"><a href="#TypeORM" class="headerlink" title="TypeORM"></a>TypeORM</h2><p><code>ORM</code>是对象关系映射器。</p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install --save typeorm mysql</span></span><br></pre></td></tr></table></figure>
</article><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/16/Mysql/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/02/03/P3sHyhJj7IZTzlK.png" onerror="onerror=null;src='/img/default_cover.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">mysql</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/05/JavaScript%E4%B8%AD%E7%9A%84this%E6%8C%87%E5%90%91/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://source.unsplash.com/random/323x300" onerror="onerror=null;src='/img/default_cover.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JavaScript中的this指向</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/img/baby.png" onerror="this.onerror=null;this.src='/img/404.gif'" alt="avatar"/></div><div class="author-info__description"></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">知瑾</h1><div class="author-info__desc">生活明朗 万物可爱</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/berniezwd" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nestjs"><span class="toc-number">1.</span> <span class="toc-text">Nestjs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Nestjs-%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.</span> <span class="toc-text">创建 Nestjs 项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.</span> <span class="toc-text">模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.1.</span> <span class="toc-text">功能模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.2.</span> <span class="toc-text">共享模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-number">1.2.3.</span> <span class="toc-text">依赖注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">全局模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.3.</span> <span class="toc-text">控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">1.3.1.</span> <span class="toc-text">路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request"><span class="toc-number">1.3.2.</span> <span class="toc-text">Request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">1.3.3.</span> <span class="toc-text">状态码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.3.4.</span> <span class="toc-text">重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.5.</span> <span class="toc-text">完整示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text">服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.5.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.5.1.</span> <span class="toc-text">应用中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.5.2.</span> <span class="toc-text">全局中间件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.6.</span> <span class="toc-text">异常过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E5%BC%82%E5%B8%B8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.6.1.</span> <span class="toc-text">简单的异常过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.6.2.</span> <span class="toc-text">绑定过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.6.3.</span> <span class="toc-text">全局异常过滤器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E9%81%93"><span class="toc-number">1.7.</span> <span class="toc-text">管道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text">管道示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E9%81%93"><span class="toc-number">1.7.2.</span> <span class="toc-text">自定义管道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%88%E5%8D%AB"><span class="toc-number">1.8.</span> <span class="toc-text">守卫</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E5%AE%88%E5%8D%AB"><span class="toc-number">1.8.1.</span> <span class="toc-text">授权守卫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E5%AE%88%E5%8D%AB"><span class="toc-number">1.8.2.</span> <span class="toc-text">绑定守卫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E6%AF%8F%E4%B8%AA%E5%A4%84%E7%90%86%E5%99%A8%E8%AE%BE%E7%BD%AE%E8%A7%92%E8%89%B2"><span class="toc-number">1.8.3.</span> <span class="toc-text">为每个处理器设置角色</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">1.9.</span> <span class="toc-text">自定义装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">1.9.1.</span> <span class="toc-text">参数装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">1.9.2.</span> <span class="toc-text">传递数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jwt-%E9%89%B4%E6%9D%83"><span class="toc-number">1.10.</span> <span class="toc-text">Jwt 鉴权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">1.10.1.</span> <span class="toc-text">身份认证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TypeORM"><span class="toc-number">1.11.</span> <span class="toc-text">TypeORM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.11.1.</span> <span class="toc-text">安装依赖</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/13/Docker%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/" title="Docker认识"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/berniezhong/picture-bed/github/202407131500894.png" onerror="this.onerror=null;this.src='/img/default_cover.jpg'" alt="Docker认识"/></a><div class="content"><a class="title" href="/2024/07/13/Docker%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/" title="Docker认识">Docker认识</a><time datetime="2024-07-12T16:00:00.000Z" title="发表于 2024-07-13 00:00:00">2024-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/13/Docker%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/" title="Docker操作命令"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/berniezhong/picture-bed/github/202407131500894.png" onerror="this.onerror=null;this.src='/img/default_cover.jpg'" alt="Docker操作命令"/></a><div class="content"><a class="title" href="/2024/07/13/Docker%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/" title="Docker操作命令">Docker操作命令</a><time datetime="2024-07-12T16:00:00.000Z" title="发表于 2024-07-13 00:00:00">2024-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/13/Docker%E5%AE%89%E8%A3%85%E4%B8%8E%E9%95%9C%E5%83%8F%E6%BA%90%E9%97%AE%E9%A2%98/" title="Docker安装与镜像源问题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/berniezhong/picture-bed/github/202407131500894.png" onerror="this.onerror=null;this.src='/img/default_cover.jpg'" alt="Docker安装与镜像源问题"/></a><div class="content"><a class="title" href="/2024/07/13/Docker%E5%AE%89%E8%A3%85%E4%B8%8E%E9%95%9C%E5%83%8F%E6%BA%90%E9%97%AE%E9%A2%98/" title="Docker安装与镜像源问题">Docker安装与镜像源问题</a><time datetime="2024-07-12T16:00:00.000Z" title="发表于 2024-07-13 00:00:00">2024-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/13/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="云服务器相关"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/berniezhong/picture-bed/github/202407131709165.png" onerror="this.onerror=null;this.src='/img/default_cover.jpg'" alt="云服务器相关"/></a><div class="content"><a class="title" href="/2024/07/13/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="云服务器相关">云服务器相关</a><time datetime="2024-07-12T16:00:00.000Z" title="发表于 2024-07-13 00:00:00">2024-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/14/%E8%B5%84%E6%BA%90%E9%9B%86%E5%90%88/" title="工具箱"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/default_cover.jpg'" alt="工具箱"/></a><div class="content"><a class="title" href="/2024/06/14/%E8%B5%84%E6%BA%90%E9%9B%86%E5%90%88/" title="工具箱">工具箱</a><time datetime="2024-06-13T16:00:00.000Z" title="发表于 2024-06-14 00:00:00">2024-06-14</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By 知瑾</div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">41</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">31</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">React</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://berniezwd.github.io/REACT_MARQUEE/" title="跑马灯"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/img/project/marquee.png" alt="跑马灯"/><span class="back-menu-item-text">跑马灯</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">有趣</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://berniezwd.github.io/PeopleJS/" title="人潮汹涌"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/default_cover.jpg&quot;" data-lazy-src="/img/project/people.png" alt="人潮汹涌"/><span class="back-menu-item-text">人潮汹涌</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 即刻短文</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>3</sup></a><a href="/tags/Html/" style="font-size: 0.88rem;">Html<sup>1</sup></a><a href="/tags/JavaScript/" style="font-size: 0.88rem;">JavaScript<sup>3</sup></a><a href="/tags/Jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" style="font-size: 0.88rem;">Jenkins自动化部署<sup>1</sup></a><a href="/tags/Nginx/" style="font-size: 0.88rem;">Nginx<sup>1</sup></a><a href="/tags/Pinia/" style="font-size: 0.88rem;">Pinia<sup>1</sup></a><a href="/tags/React/" style="font-size: 0.88rem;">React<sup>4</sup></a><a href="/tags/Redux/" style="font-size: 0.88rem;">Redux<sup>1</sup></a><a href="/tags/TypeScript/" style="font-size: 0.88rem;">TypeScript<sup>1</sup></a><a href="/tags/Vue/" style="font-size: 0.88rem;">Vue<sup>2</sup></a><a href="/tags/axios/" style="font-size: 0.88rem;">axios<sup>1</sup></a><a href="/tags/centOS/" style="font-size: 0.88rem;">centOS<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>2</sup></a><a href="/tags/electron/" style="font-size: 0.88rem;">electron<sup>2</sup></a><a href="/tags/koa/" style="font-size: 0.88rem;">koa<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>1</sup></a><a href="/tags/nestjs/" style="font-size: 0.88rem;">nestjs<sup>1</sup></a><a href="/tags/node/" style="font-size: 0.88rem;">node<sup>1</sup></a><a href="/tags/sass/" style="font-size: 0.88rem;">sass<sup>1</sup></a><a href="/tags/uniapp/" style="font-size: 0.88rem;">uniapp<sup>1</sup></a><a href="/tags/vim/" style="font-size: 0.88rem;">vim<sup>1</sup></a><a href="/tags/vite/" style="font-size: 0.88rem;">vite<sup>1</sup></a><a href="/tags/vue/" style="font-size: 0.88rem;">vue<sup>1</sup></a><a href="/tags/vue3/" style="font-size: 0.88rem;">vue3<sup>1</sup></a><a href="/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1/" style="font-size: 0.88rem;">云服务<sup>1</sup></a><a href="/tags/%E5%8F%B3%E9%94%AEcmd/" style="font-size: 0.88rem;">右键cmd<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/" style="font-size: 0.88rem;">工具类<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 0.88rem;">开发环境搭建<sup>1</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E8%B7%AF%E7%94%B1/" style="font-size: 0.88rem;">文件路由<sup>1</sup></a><a href="/tags/%E6%A0%87%E7%AD%BE%E5%A4%96%E6%8C%82/" style="font-size: 0.88rem;">标签外挂<sup>1</sup></a><a href="/tags/%E9%9B%B6%E6%95%A3/" style="font-size: 0.88rem;">零散<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>1</sup></a><a href="/tags/%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA%E8%A7%84%E8%8C%83/" style="font-size: 0.88rem;">项目搭建规范<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Rx9TnE1k1TFznGsBX5hvBTg2-gzGzoHsz',
      appKey: 'ReVHDww8qvNFAR7CALtta8S5',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://Rx9TnE1k.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'Rx9TnE1k1TFznGsBX5hvBTg2-gzGzoHsz',
        "X-LC-Key": 'ReVHDww8qvNFAR7CALtta8S5',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>